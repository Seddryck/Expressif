version: build.{build}
image: Visual Studio 2022

skip_commits:
  files:
    - docs/
    - misc/
    - README.md
    - LICENSE

environment:
  github_access_token:
    secure: j31Dt6ak1HtS5PTfhwc/He4jeCesBw9GULDRlPhNLjwBQEgFivhypRi5m4M7o3cb

init:
  - cmd: git config --global core.autocrlf true
  - ps: $env:IGNORE_NORMALISATION_GIT_HEAD_MOVE = 1

before_build:
- cmd: gitversion /output buildserver /verbosity Minimal
- cmd: echo "Building DubUrl version %GitVersion_SemVer%"

build_script:
  #- dotnet --info
  - dotnet build Expressif.sln -p:version="%GitVersion_SemVer%" -c Release /p:ContinuousIntegrationBuild=true --nologo 

test_script:
- dotnet test Expressif.Testing -c Release --test-adapter-path:. --logger:Appveyor --no-build --nologo 

after_test:
- ps: >-
    $ErrorActionPreference = "Stop"

    dotnet test -c Release /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:Threshold=90 /p:ThresholdType=line --no-build --nologo 

    if($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode )  }
- ps: >-
    get-content Expressif.Testing/coverage.net7.0.json

    $ProgressPreference = 'SilentlyContinue'
    
    Invoke-WebRequest -Uri https://uploader.codecov.io/latest/windows/codecov.exe -Outfile codecov.exe
    
    .\codecov.exe

- dotnet pack Expressif -p:version="%GitVersion_SemVer%" -c Release --include-symbols --no-build --nologo 

artifacts:
- path: '**\*.nupkg'
- path: '**\*.snupkg'

deploy:
- provider: NuGet
  api_key:
    secure: ijpxFuIlbHkjRHDylNSFkJrpw3b6+iK8bUSBP2SdtjkP6S8mCoe2Kdb0pP46WXu2
  skip_symbols: false
  artifact: /.*(\.|\.s)nupkg/
  on:
    branch: main

on_success:

  - pwsh: |
      & .\generate-info.ps1 function
      $exitCode = $LastExitCode
      & .\generate-info.ps1 predicate
      $exitCode += $LastExitCode
      if ($exitCode -gt 0) {
        Write-Host "Update of Library index needed"
        & .\update-index.ps1
        Write-Host "Update of docs needed"
        & .\update-docs.ps1 function special
        & .\update-docs.ps1 function text
        & .\update-docs.ps1 function numeric
        & .\update-docs.ps1 function temporal
        & .\update-docs.ps1 function io
        & .\update-docs.ps1 predicate special
        & .\update-docs.ps1 predicate text
        & .\update-docs.ps1 predicate numeric
        & .\update-docs.ps1 predicate temporal
        & .\update-docs.ps1 predicate boolean
        Write-Host "Update of README.md needed"
        & .\update-readme.ps1 function
        & .\update-readme.ps1 predicate
        & git config --global credential.helper store
        Set-Content -Path "$HOME\.git-credentials" -Value "https://$($env:github_access_token):x-oauth-basic@github.com`n" -NoNewline
        & git config --global user.email "no-reply@nbiguity.io"
        & git config --global user.name "AppVeyor bot"
        & git add --all
        & git status
        & git commit -m "Update the automatically generated documentation related to the list of functions and predicates"
        & git push origin
      }